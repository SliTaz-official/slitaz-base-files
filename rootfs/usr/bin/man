#!/bin/sh
#
# Tiny man fake using online manuals.
# Copyright (C) 2009-2015 SliTaz GNU/Linux.
#
. /lib/libtaz.sh

# Internationalization.
TEXTDOMAIN='slitaz-base'
. /etc/locale.conf
export TEXTDOMAIN LANG

check_retawq() {
	if [ ! -x /usr/bin/retawq ]; then
		echo; _ "Missing Retawq web browser..."
		_ 'Please run: %s' "su -c 'tazpkg get-install retawq'"
		exit 0
	fi
}

local i SECTION SECTIONS MSG TOPIC MAN_SECTION

case "$1" in
	''|-*)
		emsg "$(_ '<b>Usage:</b> man [section] command')"
		return ;;
esac

SECTION='all'
MAN_SECTION='*'
MSG=''

if [ -n "$2" ]; then
	SECTION="$1"
	MAN_SECTION="$1"
	MSG=" $(_n 'in section %s' "$SECTION")"
	shift
fi

TOPIC="$1"

if [ check_retawq -a -f /usr/share/doc/$TOPIC/$TOPIC.html ]; then
	retawq --dump=file:///usr/share/doc/$TOPIC/$TOPIC.html | less -M
	return
elif [ check_retawq -a -f /usr/share/doc/slitaz/$TOPIC.html ]; then
	retawq --dump=file:///usr/share/doc/slitaz/$TOPIC.html | less -M
	return
elif [ check_retawq -a -f /usr/share/doc/slitaz-tools/$TOPIC.html ]; then
	retawq --dump=file:///usr/share/doc/slitaz-tools/$TOPIC.html | less -M
	return
elif [ -f /usr/share/doc/slitaz/$TOPIC.txt ]; then
	# SliTaz tools/libraries documentation (man a like format)
	less -M /usr/share/doc/slitaz/$TOPIC.txt
	return
fi

for i in /usr/share/man/$LC_ALL/man$MAN_SECTION /usr/share/man/man$MAN_SECTION; do
	if [ -f $i/$TOPIC.* ]; then
		i=$(ls $i/$TOPIC.* 2> /dev/null)
		if [ "x$i" != "x" ]; then
			case "$i" in
				*gz) (zcat $i || unlzma -c $i 2>/dev/null) | less -M;;
				*) less -M $i;;
			esac
		fi
		return
	fi
	if [ check_retawq -a -f $i/$TOPIC.html ]; then
		retawq --dump=file://$i/$TOPIC.html | less -M
		return
	fi
done

if [ "$SECTION" == 'all' ]
	then SECTIONS='1 2 3 4 5 6 7 8'
	else SECTIONS="$SECTION"
fi

for SECTION in $SECTIONS; do
  URL=$( wget -q -O - http://man7.org/linux/man-pages/dir_all_alphabetic.html | \
        sed -n -r "s%.*href=\"\./(man./.*html)\">$TOPIC\($SECTION\).*%\1%p" )
  if [ -n "$URL" ]
  then
    wget -q -O - "http://man7.org/linux/man-pages/$URL" | \
    awk "BEGIN {s=0} /headline/{s=1} /COLOPHON/{s=0} {if(s) print}" | \
    sed -e 's%<span class="top-link">top</span>%%' -e 's/<[^>]*>//g' -e 's/&lt;/</g' \
        -e 's/&gt;/>/g' -e 's/&amp;/\&/g' -e 's/&nbsp;//g' | less -M
    exit 0
  fi
done
_ 'No manual entry for %s' "$TOPIC$MSG"
exit 0
